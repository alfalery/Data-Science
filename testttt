using UnityEngine;
using UnityEngine.XR.ARFoundation;
using TMPro;

[RequireComponent(typeof(ARPlaneManager))]
public class PlaneSizeDisplay : MonoBehaviour
{
    private ARPlaneManager arPlaneManager;

    void Awake()
    {
        arPlaneManager = GetComponent<ARPlaneManager>();
    }

    void OnEnable()
    {
        arPlaneManager.planesChanged += OnPlanesChanged;
    }

    void OnDisable()
    {
        arPlaneManager.planesChanged -= OnPlanesChanged;
    }

    void OnPlanesChanged(ARPlanesChangedEventArgs eventArgs)
    {
        foreach (var plane in eventArgs.added)
        {
            DisplayPlaneSize(plane);
        }

        foreach (var plane in eventArgs.updated)
        {
            DisplayPlaneSize(plane);
        }
    }

    void DisplayPlaneSize(ARPlane plane)
    {
        // Menghitung ukuran plane
        Vector2 planeSize = plane.size;
        float width = planeSize.x;
        float height = planeSize.y;
        float area = width * height;

        // Log ukuran untuk debugging
        Debug.Log($"Detected a plane with width: {width} meters, height: {height} meters, area: {area} square meters.");

        // Temukan atau buat komponen TextMeshPro pada prefab
        Transform labelTransform = plane.transform.Find("SizeLabel");
        if (labelTransform == null)
        {
            GameObject labelObject = new GameObject("SizeLabel");
            labelTransform = labelObject.transform;
            labelTransform.SetParent(plane.transform, false);

            TextMeshPro label = labelObject.AddComponent<TextMeshPro>();
            label.fontSize = 3; // Sesuaikan ukuran font sesuai kebutuhan
            label.alignment = TextAlignmentOptions.Center;
        }

        TextMeshPro labelTMP = labelTransform.GetComponent<TextMeshPro>();
        labelTMP.text = $"Width: {width:F2} m\nHeight: {height:F2} m\nArea: {area:F2} sq m";
        labelTMP.gameObject.SetActive(true);

        // Menempatkan label di tengah-tengah plane
        labelTransform.localPosition = new Vector3(0, 0, 0);
        labelTransform.localScale = new Vector3(0.1f, 0.1f, 0.1f); // Sesuaikan skala sesuai kebutuhan

        // Mengatur label agar selalu menghadap kamera
        labelTransform.LookAt(Camera.main.transform);
        labelTransform.Rotate(0, 180, 0); // Menyesuaikan rotasi agar tidak terbalik
    }
}
